@page "/"
@inject Service.JobManager JobManager
@inject NavigationManager NavigationManager
@inject IJSRuntime JS
@inject Service.FileService FileService
@inject HttpClient HttpClient

@using MongoMigrationWebApp.Components
@using OnlineMongoMigrationProcessor
@using OnlineMongoMigrationProcessor.Context
@using OnlineMongoMigrationProcessor.Helpers


<div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">        
        Migration Jobs
    </h3>
    <div class="d-flex align-items-center mb-3">
        <button class="btn btn-primary" title="New Job" @onclick="StartMigrationAsync">New Job</button>
        <button class="btn btn-light" title="Edit Migration Settings" @onclick="OpenConfig" style="border: none; background: transparent;">
            <i class="bi bi-gear"></i>
        </button>
    </div>
</div>

@if (_loadingComplete)
{
    @if (migrationJobs?.Count == 0)
    {
        <div>No migrations could be found</div>        
    }
    else
    {
        <table class="table">
            <thead>
                <tr>
                    <th></th>
                    <th>Name</th>
                    <th>Migration Tool</th>
                    <th>Started On (UTC)</th>
                    <th>Endpoints</th>
                    <th>Is Online</th>
                    <th>Is Completed</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var migration in GetMigrations())
                {
                    <tr>
                        <td>
                            @if (JobManager.IsProcessRunning(migration.Id ?? string.Empty))
                            {
                                <i class="bi bi-star-fill text-warning"></i>
                            }
                        </td>
                        <td>
                            <i class="bi bi-download me-2 collection-info-icon" title="Download Job JSON" style="cursor: pointer;"
                               @onclick="() => DownloadJob(migration)"></i>
                            @migration.Name
                        </td>
                        <td>@GetToolName(migration.JobType)</td>
                        <td>@migration.StartedOn</td>
                        <td class="tooltip-text" title="@GetTootTip(migration)">@migration.SourceEndpoint<br /> to <br /> @migration.TargetEndpoint</td>
                        <td>@Helper.IsOnline(migration)</td>
                        <td>@migration.IsCompleted</td>
                        <td>
                            <button class="btn btn-primary" title="View Job" @onclick="() => ViewMigration(migration.Id)">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-success" title="Job Report" @onclick="() => ViewJobReport(migration.Id)">
                                <i class="bi bi-printer"></i>
                            </button>
                            <button class="btn btn-secondary" title="Delete Job" @onclick="() => RemoveMigration(migration.Id)">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>        
    }
}

@if (_migrationDetailsPopUpOpen)
{
    <MigrationDetails NewMode=true OnSubmit="@OnMigrationDetailsPopUpSubmit" CheckNameExists="CheckIfNameExistsAsync" />
}

@if (_yesNoDialogOpen)
{
    <YesNoDialog Type="YesNoDialog.Category.DeleteNot" Caption="Confirm Delete" Message="@_message" OnClose="@YesNoDialogSubmit" />
}


@if (_messageDialogOpen)
{
    <YesNoDialog Type="YesNoDialog.Category.Okay" Caption="Message" Message="@_message" OnClose="@YesNoDialogSubmit" />
}

@if (_editSettingsOpen)
{
    <MigrationSettings _configuration="@GetConfig()" On_configurationSaved="HandleConfigurationSaved" />
}

@code {
    #pragma warning disable CS8603
#pragma warning disable CS8604
#pragma warning disable CS8600

    private bool _migrationDetailsPopUpOpen;
    private bool _yesNoDialogOpen;
    private bool _messageDialogOpen;
    private bool _editSettingsOpen;

    private string _message = string.Empty;
    private MigrationJob? _selectedMigrationJob;
    private List<MigrationJob>? migrationJobs;
    private bool _loadingComplete;

    private string GetTootTip(MigrationJob migrationJob)
    {

        return string.Join(",",
            migrationJob.MigrationUnitBasics?
                .Select(mu => $"{mu.DatabaseName}.{mu.CollectionName}") ?? Enumerable.Empty<string>());
    }


    private string GetToolName(OnlineMongoMigrationProcessor.Models.JobType jobType)
    {
        switch(jobType)
        {
            case OnlineMongoMigrationProcessor.Models.JobType.RUOptimizedCopy:
                return "MongoDB Driver (Cosmos DB RU read optimized)";
            case OnlineMongoMigrationProcessor.Models.JobType.MongoDriver:
                return "MongoDB Driver";
            case OnlineMongoMigrationProcessor.Models.JobType.DumpAndRestore:
                return "MongoDump and MongoRestore";
            default:
                return "NA";
        }
    }

    protected override async Task OnInitializedAsync()
    {
        // Update WebAppBaseUrl from browser context for Keep-Alive functionality
        try
        {
            var baseUri = NavigationManager.BaseUri;
            JobManager.UpdateWebAppBaseUrlFromBrowser(baseUri);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error updating WebAppBaseUrl. Details: {ex}");
        }

        await base.OnInitializedAsync();
    }

#pragma warning disable CS1998
    protected override async Task OnParametersSetAsync()
    {
        if (_loadingComplete)
            return;

        _loadingComplete = false;
        migrationJobs = GetMigrationsFromManager(false);
        _loadingComplete = true;
    }
#pragma warning restore CS1998
#pragma warning disable CS8602

    private List<MigrationJob> GetMigrations()
    {
        return GetMigrationsFromManager(true);
    }

    private List<MigrationJob> GetMigrationsFromManager(bool silent)
    {
        var ids = JobManager.GetMigrationIds();
        var result = MigrationJobContext.PopulateMigrationJobs(ids);
        return result;
    }


    private void RemoveMigration(string? id)
    {
        _selectedMigrationJob = JobManager.GetMigrationJobById(id);       
        if (!JobManager.IsProcessRunning(id ?? string.Empty))
        {
            _message = "Are you sure you want to delete " + _selectedMigrationJob.Name + " ?";
            _yesNoDialogOpen = true;
        }
        else
        {
            _message = "Can't delete active job " + _selectedMigrationJob.Name + ". Please stop the job and try again.";
            _messageDialogOpen = true;
        }
    }

    private void YesNoDialogSubmit(YesNoDialog.YesNoDialogResult result)
    {
        if (_messageDialogOpen)
        {
            _messageDialogOpen = false;
            return;
        }
        else
        {
            _yesNoDialogOpen = false;


            if (result.IsConfirmed && (!JobManager.IsProcessRunning(_selectedMigrationJob?.Id ?? string.Empty)))
            {

                if (_selectedMigrationJob != null)
                {
                    string jobId = _selectedMigrationJob.Id;
                    GetMigrations().Remove(_selectedMigrationJob);

                    try
                    {
                        JobManager.ClearJobFiles(jobId);
                    }
                    catch { }
                }

            }

            _selectedMigrationJob = null;
        }
    }

    private OnlineMongoMigrationProcessor.MigrationSettings GetConfig()
    {
        return JobManager.GetConfig();
    }



    private void OpenConfig()
    {
        _editSettingsOpen = true;
    }

    private void HandleConfigurationSaved(OnlineMongoMigrationProcessor.MigrationSettings updatedConfig)
    {
        _editSettingsOpen = false;

        if (updatedConfig != null)
        {            
            if (!JobManager.UpdateConfig(updatedConfig, out string errorMessage))
            {
                _message = errorMessage;
                _messageDialogOpen = true;
            }
        }
    }

    private void ViewMigration(string? id)
    {

        NavigationManager.NavigateTo($"/migrationjobviewer/{id}");
    }

    private void ViewJobReport(string? id)
    {
        NavigationManager.NavigateTo($"/jobreport/{id}");
    }

    private void StartMigrationAsync()
    {
        _selectedMigrationJob = null;
        _migrationDetailsPopUpOpen = true;
    }

    private Task<bool> CheckIfNameExistsAsync(string name)
    {
        var migrationJob = GetMigrations().Find(m => m.Name == name);
        return Task.FromResult(migrationJob != null);
    }

    private async Task<bool> OnMigrationDetailsPopUpSubmit(MigrationJob job, string sourceConnectionString, string targetConnectionString)
    {
        _migrationDetailsPopUpOpen = false;
        if (job != null)
        {
            if (_selectedMigrationJob == null)
            {
                // Store connection strings if provided
                if (!string.IsNullOrEmpty(sourceConnectionString))
                    MigrationJobContext.SourceConnectionString[job.Id] = sourceConnectionString;

                if (!string.IsNullOrEmpty(targetConnectionString))
                    MigrationJobContext.TargetConnectionString[job.Id] = targetConnectionString;

                MigrationJobContext.JobList.MigrationJobIds.Add(job.Id);
                job.IsStarted = true;

                MigrationJobContext.SaveMigrationJob(job);
                MigrationJobContext.SaveJobList();
                
                ViewMigration(job.Id);
            }
        }
        await InvokeAsync(StateHasChanged);
        return true;
    }

    private async Task DownloadJob(MigrationJob job)
    {
        if (string.IsNullOrEmpty(job?.Id))
        {
            return;
        }

        var url = $"/api/File/download/job/{job.Id}";
        var response = await HttpClient.GetAsync(url);

        if (response.IsSuccessStatusCode)
        {
            var fileBytes = await response.Content.ReadAsByteArrayAsync();
            var contentType = response.Content.Headers.ContentType?.ToString() ?? "application/octet-stream";
            var fileName = $"{job.Name}_{job.Id}.json";

            // Use JavaScript to trigger the file download
            await JS.InvokeVoidAsync("downloadFile", fileBytes, fileName, contentType);
        }
        else
        {
            await JS.InvokeVoidAsync("open", url, "_blank"); // browser navigates directly
        }
    }
}
